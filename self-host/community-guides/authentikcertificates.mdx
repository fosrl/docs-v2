---
title: "Authentik OIDC Certificate Synchronization"
---

<Note>
	This is a community guide and is not officially supported. If you experience issues, please contact the
	[author](https://github.com/sohukia) of this guide.
</Note>

This guide explains how to synchronize Traefik ACME certificates generated by Pangolin with an Authentik instance running under Docker Compose.  
This synchronization is **required** if you want Authentik to use the same certificate as Pangolin for **OIDC token signing**, preventing token validation errors when Pangolin uses Authentik as an SSO provider.

This guide also explains the certificate flow, outlines best practices, and provides a reference implementation using `traefik-certs-dumper`, `rsync`, `systemd timers`, and hardened SSH access.

---

# Why Certificate Synchronization is Required

When using Authentik as an OIDC provider behind Pangolin:

- Pangolin (Traefik) terminates TLS and handles ACME certificates.
- Authentik signs OIDC tokens (JWT) using a certificate key pair.
- Pangolin must be able to validate these JWT signatures.

If Authentik and Pangolin use **different certificates**, JWT signature validation will break, triggering errors such as:

<Frame caption='Pangolin issue with traefik'>
	<img
		src='/images/error_authentik.png'
		alt='Error Authentik'
	/>
</Frame>

To avoid this, we configure Authentik to **use the same ACME certificate** that Pangolin/Traefik already generated.

This guide explains how to automate the process.

---

# Overview of the Synchronization Flow

```
           ┌────────────────────────────┐
           │    Pangolin Host           │
           │  (Traefik + ACME Certs)    │
           └──────────────┬─────────────┘
                          │
   Dump certs using       │   Sync via rsync+SSH
 traefik-certs-dumper     ▼
                    ┌──────────────────────┐
                    │      SSO Host        │
                    │   (Authentik Docker) │
                    └──────────┬───────────┘
                               │
         Authentik mounts this │ directory as `/certs`
                               ▼
                     Authentik auto-imports
                     signing keys from `/certs`
```

This ensures Authentik always uses the latest ACME certificate.

---

# Requirements

- Pangolin host with Traefik and ACME enabled.
- Authentik running via Docker Compose.
- SSH key login possible from Pangolin → Authentik host.
- Basic systemd and rsync installed.

---

# 1. Configure the Synchronization Script (Pangolin Host)

Create this script on the Pangolin host:

`/usr/local/bin/sync-sso-certs.sh`

```bash
#!/bin/bash
set -euo pipefail

REMOTE_HOST="<SSO_HOST_IP>"
REMOTE_USER="certsync"
REMOTE_PATH="certs"
CERT_DUMPER_BIN="/usr/local/bin/traefik-certs-dumper"
SSO_HOST="sso.example.com"

# Ensure traefik-certs-dumper is installed
if [[ ! -x "$CERT_DUMPER_BIN" ]]; then
    echo "Installing traefik-certs-dumper..."
    curl -sfL https://raw.githubusercontent.com/ldez/traefik-certs-dumper/master/godownloader.sh \
        | bash -s -- -b /usr/local/bin v2.9.3
fi

# Dump ACME certificates
$CERT_DUMPER_BIN file \
  --version v3 \
  --source /root/config/certs/acme-letsencrypt.json \
  --dest /root/certs-dumped \
  --domain-subdir \
  --crt-name=fullchain \
  --key-name=privkey \
  --crt-ext=.pem \
  --key-ext=.pem

# Ensure the certificate for the SSO host exists
if [[ ! -d "/root/certs-dumped/$SSO_HOST" ]]; then
    echo "ERROR: No certs for $SSO_HOST"
    exit 1
fi

# Avoid root-owned permissions
chown nobody:nobody "/root/certs-dumped/$SSO_HOST"

# Ensure SSO host is reachable
if ! ping -c 2 -q -W 2 "$REMOTE_HOST" >/dev/null; then
    echo "ERROR: Remote host unreachable"
    exit 1
fi

# Sync certificates to the Authentik host
rsync -av -e "ssh -i <PRIVATE_KEY_PATH>" \
    "/root/certs-dumped/${SSO_HOST}/" \
    "${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}/"
```

Make it executable:

```bash
chmod +x /usr/local/bin/sync-sso-certs.sh
```

---

# 2. Systemd Task and Timer (Pangolin Host)

To automate synchronization:

`/etc/systemd/system/certsync.service`

```ini
[Unit]
Description=Dump and sync Pangolin certificates to SSO
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/sync-sso-certs.sh
User=root
Group=root
```

`/etc/systemd/system/certsync.timer`

```ini
[Unit]
Description=Run certsync script every 30 minutes

[Timer]
OnBootSec=2m
OnUnitActiveSec=30m
Persistent=true

[Install]
WantedBy=timers.target
```

Enable the timer:

```bash
systemctl daemon-reload
systemctl enable --now certsync.timer
```

---

# 3. Prepare the Authentik Host

## 3.1 Create the restricted synchronization user

```bash
useradd -s /bin/bash certsync
```

## 3.2 Harden SSH access for this user

`/etc/ssh/sshd_config.d/certsync.conf`

```ini
Match User certsync
    PasswordAuthentication no
    PermitTTY no
    AllowTcpForwarding no
    X11Forwarding no
```

Apply changes:

```bash
systemctl restart sshd
```

---

# 4. Configure the Certificate Directory for Authentik

Authentik must receive the certificates in a stable directory.

Create `/srv/certs`:

```bash
mkdir -p /srv/certs
chown certsync:certsync -R /srv/certs
chmod 750 -R /srv/certs
```

You may optionally create a boot-time cron to reassert permissions.

---

# 5. Mount the Certificate Directory into Authentik (Docker Compose)

Assuming your `docker-compose.yml` resembles:

```yaml
services:
  server:
    image: ghcr.io/goauthentik/server
    volumes:
      - ./certs:/certs
```

Create a symlink so `/srv/certs` becomes Authentik’s mounted directory:

```bash
ln -s /srv/certs ./certs
```

Restart Authentik:

```bash
docker compose restart
```

Authentik will automatically import PEM certificates placed in `/certs`.

---

# 6. Trigger Certificate Discovery in Authentik

Inside the Authentik UI:

**System → System Tasks → Search “cert”**

Run:

```
Discover, import...
```

Imported certificates appear under:

**System → Certificates**

Ensure your domain certificate is listed.

---

# 7. Use the Certificate as the OIDC Signing Key

Go to your OIDC Provider (used by Pangolin):

**Applications → Providers → \<Your Provider\> → Signing Key**

Select the imported certificate (`fullchain.pem + privkey.pem` pair).

This ensures Pangolin can validate JWT signatures properly.

---

# 8. Testing and Troubleshooting

## 8.1 Check that a new ACME certificate syncs properly

On Pangolin host:

```bash
systemctl start certsync.service
```

Verify files appear under the Authentik host:

```bash
ls -l /srv/certs/<YOUR_DOMAIN>/
```

## 8.2 Check Authentik imported the updated certificate

In Authentik UI:

System → Certificates

## 8.3 Common issues

### Missing certificate in Authentik

Ensure the symlink points to a directory that Docker actually mounts.

### Wrong domain directory

Traefik creates `certs-dumped/<domain.tld>/`.  
Ensure `SSO_HOST` in the script matches exactly the hostname used by ACME.

### Token validation errors persist

Ensure the Provider → Signing Key matches the imported key pair.

---

# Conclusion

By synchronizing ACME certificates from Pangolin to Authentik and using them as the OIDC signing key, you ensure that:

- Authentik signs tokens using a trusted certificate
- Pangolin validates OIDC tokens correctly
- Certificate rotation happens automatically
- The setup remains secure and fully automated

This is the recommended architecture when using Authentik as an OIDC provider behind Pangolin.
